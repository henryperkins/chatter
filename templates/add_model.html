{% extends "base.html" %}

{% block title %}Add Model - Azure OpenAI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Page Header -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Add a New AI Model</h1>

    <!-- Form -->
    <form id="add-model-form" method="POST" action="{{ url_for('model.create_model') }}">
        {{ form.hidden_tag() }}

        <!-- Model Name -->
        <div class="mb-4">
            {{ form.name.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.name(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                focus:outline-none focus:ring-2 focus:ring-blue-500 
                                focus:border-transparent") }}
            {% if form.name.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.name.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Deployment Name -->
        <div class="mb-4">
            {{ form.deployment_name.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.deployment_name(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 
                                            focus:border-transparent") }}
            {% if form.deployment_name.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.deployment_name.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Description -->
        <div class="mb-4">
            {{ form.description.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.description(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 
                                        focus:border-transparent") }}
            {% if form.description.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.description.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- API Endpoint -->
        <div class="mb-4">
            {{ form.api_endpoint.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.api_endpoint(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                         focus:outline-none focus:ring-2 focus:ring-blue-500 
                                         focus:border-transparent") }}
            {% if form.api_endpoint.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.api_endpoint.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Model Type -->
        <div class="mb-4">
            {{ form.model_type.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.model_type(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 
                                        focus:border-transparent") }}
            {% if form.model_type.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.model_type.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Temperature -->
        <div class="mb-4">
            {{ form.temperature.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.temperature(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 
                                        focus:border-transparent") }}
            {% if form.temperature.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.temperature.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Max Tokens and Max Completion Tokens -->
        <div class="grid grid-cols-2 gap-4">
            <div class="mb-4">
                {{ form.max_tokens.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
                {{ form.max_tokens(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 
                                            focus:border-transparent") }}
                {% if form.max_tokens.errors %}
                    <p class="text-sm text-red-500 mt-1">{{ form.max_tokens.errors[0] }}</p>
                {% endif %}
            </div>
            <div class="mb-4">
                {{ form.max_completion_tokens.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
                {{ form.max_completion_tokens(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                                    focus:outline-none focus:ring-2 focus:ring-blue-500 
                                                    focus:border-transparent") }}
                {% if form.max_completion_tokens.errors %}
                    <p class="text-sm text-red-500 mt-1">{{ form.max_completion_tokens.errors[0] }}</p>
                {% endif %}
            </div>
        </div>

        <!-- API Version -->
        <div class="mb-4">
            {{ form.api_version.label(class="text-sm font-semibold text-gray-700 block mb-2") }}
            {{ form.api_version(class="w-full border border-gray-300 rounded-lg shadow-sm px-3 py-2 
                                         focus:outline-none focus:ring-2 focus:ring-blue-500 
                                         focus:border-transparent") }}
            {% if form.api_version.errors %}
                <p class="text-sm text-red-500 mt-1">{{ form.api_version.errors[0] }}</p>
            {% endif %}
        </div>

        <!-- Requires o1-preview Handling -->
        <div class="mb-4">
            <label class="inline-flex items-center">
                {{ form.requires_o1_handling(class="h-5 w-5 text-blue-600 form-checkbox 
                                               focus:ring-blue-500 focus:ring-2") }}
                <span class="ml-2 text-sm text-gray-700 font-medium">
                    {{ form.requires_o1_handling.label.text }}
                </span>
            </label>
        </div>

        <!-- Default Model Option -->
        <div class="mb-6">
            <label class="inline-flex items-center">
                {{ form.is_default(class="h-5 w-5 text-blue-600 form-checkbox 
                                      focus:ring-blue-500 focus:ring-2") }}
                <span class="ml-2 text-sm text-gray-700 font-medium">
                    {{ form.is_default.label.text }}
                </span>
            </label>
        </div>

        <!-- Submit & Cancel -->
        <div class="flex space-x-4">
            <button
                type="submit"
                class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-lg font-medium 
                       hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
            >
                Add Model
            </button>
            <a
                href="{{ url_for('chat.chat_interface') }}"
                class="px-4 py-2 bg-gray-500 text-white rounded-lg shadow-lg font-medium 
                       hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500"
            >
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- Feedback Message -->
<div
    id="feedback-message"
    class="hidden fixed bottom-4 right-4 p-4 rounded-lg"
></div>

<!-- JavaScript for handling form submission without "type=module" -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("add-model-form");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Because chat.js attaches these to the window, we can reference them directly:
        const { getCSRFToken, showFeedback } = window;

        try {
            const submitButton = form.querySelector("button[type='submit']");
            submitButton.disabled = true; // prevent duplicate submissions

            const formData = new FormData(form);

            const response = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": getCSRFToken()
                }
            });

            const data = await response.json();

            if (response.ok) {
                showFeedback(data.message || "Model created successfully", "success");
                // Optionally redirect after a delay:
                setTimeout(() => {
                    window.location.href = "{{ url_for('chat.chat_interface') }}";
                }, 1500);
            } else {
                showFeedback(data.error || "Failed to create the model", "error");
                submitButton.disabled = false; 
            }
        } catch (err) {
            console.error("Error:", err);
            window.showFeedback("An unexpected error occurred. Please try again.", "error");
            form.querySelector("button[type='submit']").disabled = false;
        }
    });
});
</script>
{% endblock %}