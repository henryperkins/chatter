{% extends "base.html" %}

{% block title %}Chat - Azure OpenAI{% endblock %}

{% block main_classes %}container mx-auto p-0 h-screen flex{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 h-full">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 md:flex md:flex-col md:col-span-1 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto z-40" aria-label="Chat navigation">
        <div class="flex-none p-4 space-y-4">
            <!-- New Chat Button -->
            <button id="new-chat-btn" class="w-full flex items-center justify-center bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded shadow font-medium transition-colors duration-200" aria-label="Start new chat">
                <!-- Heroicon: Plus Icon -->
                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Chat
            </button>

            <!-- Model Selection -->
            {% if models %}
            <div>
                <label for="model-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model:</label>
                <select id="model-select" data-original-value="{{ model_id }}" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:text-gray-200">
                    {% for model in models %}
                    <option value="{{ model.id }}" {% if model.is_default %}selected{% endif %}>
                        {{ model.name }}{% if model.is_default %} (Default){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Admin Buttons -->
            {% if current_user.role == 'admin' %}
            <div class="space-y-2">
                <a href="{{ url_for('model.add_model_page') }}"
                   class="block w-full bg-secondary hover:bg-secondary-dark text-white px-4 py-2 rounded shadow font-medium text-center transition-colors duration-200">
                    <!-- Heroicon: Device Laptop Icon -->
                    <svg class="h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17h5.5M3.75 7h16.5M5.25 8v7.25m13.5-7.25v7.25"/>
                    </svg>
                    Add Model
                </a>
                <button id="edit-model-btn"
                        class="block w-full bg-warning hover:bg-yellow-600 text-white px-4 py-2 rounded shadow font-medium text-center transition-colors duration-200"
                        aria-label="Edit current model settings">
                    <!-- Heroicon: Pencil Icon -->
                    <svg class="h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h-6a2 2 0 00-2 2v14l2-2h16a2 2 0 002-2V9M16 3l5 5L9 20l-5 1 1-5L16 3z"/>
                    </svg>
                    Edit Model
                </button>
            </div>
            {% endif %}

            <!-- Chat List -->
            <div class="flex-1 overflow-y-auto space-y-4">
                {% set ns = namespace(current_date=None) %}
                {% for conversation in conversations|sort(attribute='timestamp', reverse=True) %}
                {% set chat_date = conversation.timestamp.strftime('%Y-%m-%d') %}

                {% if chat_date != ns.current_date %}
                {% set ns.current_date = chat_date %}
                <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider pt-4 first:pt-0">
                    {% if chat_date == today %}
                        Today
                    {% elif chat_date == yesterday %}
                        Yesterday
                    {% else %}
                        {{ conversation.timestamp.strftime('%B %d, %Y') }}
                    {% endif %}
                </div>
                {% endif %}

                <div class="relative group">
                    <a href="{{ url_for('chat.chat_interface', chat_id=conversation.id) }}"
                       class="block p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-primary transition-colors duration-200 {% if conversation.id == chat_id %}bg-gray-300 dark:bg-gray-600{% else %}bg-transparent{% endif %}">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                {{ conversation.title }} - {{ conversation.model_name }}
                            </span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                {{ conversation.timestamp.strftime('%I:%M %p') }}
                            </span>
                        </div>
                    </a>
                    <button class="absolute right-2 top-1/2 -translate-y-1/2 hidden group-hover:flex items-center justify-center h-8 w-8 rounded-full hover:bg-red-100 dark:hover:bg-red-900 text-red-600 dark:text-red-400 delete-chat-btn focus:ring-2 focus:ring-red-500"
                            data-chat-id="{{ conversation.id }}" title="Delete chat">
                        <!-- Heroicon: Trash Icon -->
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.136 21H7.864a2
                            2 0 01-1.997-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0
                            00-1-1h-4a1 1 0 00-1
                            1v2m-3 0h12"/>
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <div class="col-span-1 md:col-span-3 flex flex-col overflow-hidden z-0 md:z-auto">
        <!-- Chat Header -->
        <div class="flex items-center justify-between px-4 py-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="flex items-center">
                <!-- Mobile Sidebar Toggle -->
                <button id="chat-sidebar-toggle" class="md:hidden mr-2 p-2 focus:outline-none text-gray-500 dark:text-gray-400 hover:text-primary transition-colors duration-200" aria-label="Open sidebar">
                    <!-- Heroicon: Menu Icon -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4
                        6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h2 id="chat-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    {{ chat_title }} - {{ model_name }}
                </h2>
                <button id="edit-title-btn" class="ml-4 text-sm text-primary hover:underline transition-colors duration-200" aria-label="Edit chat title">
                    <!-- Heroicon: Pencil Icon -->
                    <svg class="h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11
                        5h-6a2 2 0 00-2 2v14l2-2h16a2 2
                        0 002-2V9M16 3l5 5L9 20l-5 1
                        1-5L16 3z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-box" class="flex-1 overflow-y-auto px-4 py-6 space-y-4" role="log" aria-live="polite">
            {% if messages %}
                {% for message in messages %}
                    {% if message.role == 'user' %}
                        <!-- User message -->
                        <div class="flex justify-end mb-4">
                            <div class="bg-primary text-white py-2 px-4 rounded-lg max-w-md shadow-lg">
                                <p class="text-sm break-words">{{ message.content }}</p>
                                {% if loop.last %}
                                <button class="edit-message-button absolute top-2 right-2 text-white hover:text-gray-200" title="Edit message">
                                    <!-- Heroicon: Pencil Icon -->
                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11
                                        5h-6a2 2 0 00-2 2v14l2-2h16a2 2
                                        0 002-2V9M16 3l5 5L9 20l-5 1
                                        1-5L16 3z"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 leading-none mt-1">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                        </div>
                    {% else %}
                        <!-- Assistant message -->
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 py-2 px-4 rounded-lg max-w-md shadow-lg">
                                <div class="prose dark:prose-invert prose-sm max-w-none">
                                    {{ message.content|safe }}
                                </div>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 leading-none mt-1">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="text-center text-gray-500">
                    <p>This is a new chat. Start typing to begin!</p>
                </div>
            {% endif %}
        </div>

        <!-- Input Area -->
        <div class="flex-none px-4 py-2 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row items-start sm:items-end space-y-2 sm:space-y-0 sm:space-x-3">
                <!-- Upload Button -->
                <button id="upload-button" class="w-full sm:w-auto flex items-center justify-center bg-secondary hover:bg-secondary-dark text-white px-4 py-2 rounded shadow font-medium transition-colors duration-200" aria-label="Upload files">
                    <!-- Heroicon: Upload Icon -->
                    <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4
                        16v1a2 2 0 002 2h12a2 2 0
                        002-2v-1M16 12l-4-4-4 4m4
                        -4v12"/>
                    </svg>
                    Upload
                </button>
                <input type="file" id="file-input" class="hidden" multiple>

                <!-- Message Input and Send Button -->
                <div class="flex w-full space-x-2">
                    <div id="message-input-container" class="flex-1">
                        <textarea id="message-input"
                                  class="w-full px-4 py-2 resize-none border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 transition-colors duration-200"
                                  placeholder="Type your message..."
                                  rows="1"
                                  aria-label="Message input"
                                  maxlength="1000"></textarea>
                    </div>

                    <!-- Send Button -->
                    <button id="send-button"
                            class="w-full sm:w-auto flex items-center justify-center bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded shadow font-medium transition-colors duration-200"
                            type="button" aria-label="Send message">
                        <!-- Heroicon: Paper Airplane Icon -->
                        <svg class="h-5 w-5 transform rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4
                            10h16M4 10l6
                            6m-6-6l6-6"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drop Zone -->
<div id="drop-zone" class="hidden sm:flex fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 items-center justify-center transition-opacity duration-300" role="dialog" aria-label="File drop zone">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
        <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">Drop files here</p>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Release to upload</p>
    </div>
</div>

<!-- Upload Progress -->
<div id="upload-progress" class="hidden fixed bottom-20 right-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 w-64 transition-all duration-300 transform translate-y-0" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
    <div class="text-sm mb-2 text-gray-800 dark:text-gray-100">Uploading files...</div>
    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div id="upload-progress-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
    </div>
</div>

<!-- Feedback Message -->
<div id="feedback-message" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 max-w-md w-full text-center"></div>

{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Include Dependency Scripts -->
<script src="{{ url_for('static', filename='js/dompurify.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/axios.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/markdown-it.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/prism.js') }}"></script>
<script src="{{ url_for('static', filename='js/markdown-it-bundle.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>

<!-- Initialize required globals -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Expose DOMPurify globally
        if (typeof DOMPurify !== 'undefined') {
            window.DOMPurify = DOMPurify;
        } else {
            console.error('DOMPurify is not loaded');
        }

        // Expose Prism globally
        if (typeof Prism !== 'undefined') {
            window.Prism = Prism;
        } else {
            console.error('Prism is not loaded');
        }

        // markdown-it is initialized in markdown-it-bundle.js
        if (!window.md) {
            console.error('markdown-it bundle is not loaded');
        }
    });
</script>

<!-- Define CHAT_CONFIG before loading chat.js -->
<script>
    window.CHAT_CONFIG = {
        chatId: "{{ chat_id }}",
        editModelUrl: "{{ url_for('model.edit_model', model_id=0) }}",
        maxFileSize: parseInt("{{ config.get('MAX_FILE_SIZE', 10 * 1024 * 1024)|string }}"),
        maxFiles: parseInt("{{ config.get('MAX_FILES', 5)|string }}"),
        maxMessageLength: parseInt("{{ config.get('MAX_MESSAGE_LENGTH', 1000)|string }}"),
        allowedFileTypes: JSON.parse('{{ config.get("ALLOWED_FILE_TYPES", ["text/plain", "application/pdf", "text/x-python", "application/javascript", "text/markdown", "image/jpeg", "image/png", "text/csv"])|tojson|safe }}'),
        csrfToken: "{{ csrf_token() }}",
        userId: "{{ current_user.id }}",
        userRole: "{{ current_user.role }}"
    };

    // Initialize models data
    window.CHAT_CONFIG.models = JSON.parse('{{ models|tojson|safe }}');

    // Validate chat configuration
    if (!window.CHAT_CONFIG.chatId) {
        console.warn('Chat ID not initialized');
    }
    if (!window.CHAT_CONFIG.csrfToken) {
        console.error('CSRF token not found');
    }
</script>

<!-- Load chat.js -->
<script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
{% endblock %}
