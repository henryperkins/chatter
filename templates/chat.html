{% extends "base.html" %}

{% block title %}Chat - Azure OpenAI{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row h-[calc(100vh-4rem)] overflow-hidden bg-white dark:bg-gray-900">
    <!-- Sidebar -->
    <nav id="sidebar" class="fixed md:relative z-fixed transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out w-64 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 h-full overflow-hidden flex flex-col" aria-label="Chat navigation">
        <div class="flex-none p-4 space-y-4">
            <!-- New Chat Button -->
            <button id="new-chat-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200" aria-label="Start new chat">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Chat
            </button>

            <!-- Model Selection -->
            {% if models %}
            <div>
                <label for="model-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model:</label>
                <select id="model-select" data-original-value="{{ model_id }}" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    {% for model in models %}
                    <option value="{{ model.id }}" {% if model.is_default %}selected{% endif %}>
                        {{ model.name }}{% if model.is_default %} (Default){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Admin Buttons -->
            {% if current_user.role == 'admin' %}
            <div class="space-y-2">
                <a href="{{ url_for('model.add_model_page') }}"
                   class="block w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-center">
                    Add Model
                </a>
                <button id="edit-model-btn"
                        class="block w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-center transition-colors duration-200"
                        aria-label="Edit current model settings">
                    Edit Model
                </button>
            </div>
            {% endif %}

            <!-- Chat List -->
            <div class="flex-1 overflow-y-auto space-y-4">
                {% set ns = namespace(current_date=None) %}
                {% for conversation in conversations|sort(attribute='timestamp', reverse=True) %}
                {% set chat_date = conversation.timestamp.strftime('%Y-%m-%d') %}

                {% if chat_date != ns.current_date %}
                {% set ns.current_date = chat_date %}
                <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider pt-4 first:pt-0">
                    {% if chat_date == today %}
                        Today
                    {% elif chat_date == yesterday %}
                        Yesterday
                    {% else %}
                        {{ conversation.timestamp.strftime('%B %d, %Y') }}
                    {% endif %}
                </div>
                {% endif %}

                <div class="relative group">
                    <a href="{{ url_for('chat.chat_interface', chat_id=conversation.id) }}"
                       class="block p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500
                              {% if conversation.id == chat_id %}bg-gray-300 dark:bg-gray-600{% endif %}">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                {{ conversation.title }} - {{ conversation.model_name }}
                            </span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                {{ conversation.timestamp.strftime('%I:%M %p') }}
                            </span>
                        </div>
                    </a>
                    <button class="absolute right-2 top-1/2 -translate-y-1/2 hidden group-hover:flex items-center justify-center h-8 w-8 rounded-full hover:bg-red-100 dark:hover:bg-red-900 text-red-600 dark:text-red-400 delete-chat-btn focus:ring-2 focus:ring-red-500"
                            data-chat-id="{{ conversation.id }}" title="Delete chat">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </nav>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Chat Header -->
        <div class="chat-header px-4 py-2 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center">
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-toggle" class="md:hidden mr-2 p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200" aria-label="Toggle chat sidebar">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h2 id="chat-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    {{ chat_title }} - {{ model_name }}
                </h2>
                <button id="edit-title-btn" class="ml-4 text-sm text-blue-600 hover:underline transition-colors duration-200" aria-label="Edit chat title">
                    Edit Title
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-box" class="flex-1 overflow-y-auto px-4 py-6 space-y-4" role="log" aria-live="polite">
            {% for message in messages %}
                {% if message.role == 'user' %}
                    <!-- User message -->
                    <div class="flex w-full mt-2 space-x-3 max-w-2xl ml-auto justify-end">
                        <div>
                            <div class="relative bg-blue-600 text-white p-3 rounded-l-lg rounded-br-lg">
                                <p class="text-sm break-words overflow-x-auto">{{ message.content }}</p>
                                {% if loop.last %}
                                <button class="edit-message-button absolute -left-6 top-2 text-gray-500 hover:text-gray-700"
                                        title="Edit message">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                                {{ message.timestamp.strftime('%I:%M %p') if message.timestamp else now().strftime('%I:%M %p') }}
                            </span>
                        </div>
                    </div>
                {% else %}
                    <!-- Assistant message -->
                    <div class="flex w-full mt-2 space-x-3 max-w-3xl">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-700" role="img" aria-label="Assistant avatar"></div>
                        <div class="relative max-w-3xl">
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-r-lg rounded-bl-lg">
                                <div class="prose dark:prose-invert prose-sm max-w-none overflow-x-auto">
                                    {{ message.content|safe }}
                                </div>
                            </div>
                            <div class="absolute right-0 top-0 flex space-x-2">
                                <button class="copy-button p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                                        title="Copy to clipboard">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                    </svg>
                                </button>
                                {% if loop.last %}
                                <button class="regenerate-button p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                                        title="Regenerate response">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1">
                                {{ message.timestamp.strftime('%I:%M %p') if message.timestamp else now().strftime('%I:%M %p') }}
                            </span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- File Upload Area -->
        <div id="uploaded-files" class="hidden px-4 py-2 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <h3 class="text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">
                Uploaded Files
            </h3>
            <div id="file-list" class="space-y-2"></div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-3 bg-white dark:bg-gray-900">
            <div class="flex items-end space-x-3">
                <!-- Upload Button -->
                <button id="upload-button" class="p-2 rounded-lg text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center transition-colors duration-200" aria-label="Upload files">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Upload</span>
                </button>
                <input type="file" id="file-input" class="hidden" multiple>

                <!-- Message Input -->
                <div id="message-input-container" class="flex-1">
                    <textarea id="message-input"
                              class="w-full px-3 py-2 resize-none border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 transition-colors duration-200"
                              placeholder="Type your message..."
                              rows="1"
                              aria-label="Message input"
                              maxlength="1000"></textarea>
                </div>

                <!-- Send Button -->
                <button id="send-button"
                        class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 flex items-center transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
                        type="button"
                        aria-label="Send message">
                    <span class="relative">Send</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Drop Zone -->
<div id="drop-zone" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-modal flex items-center justify-center transition-opacity duration-300" role="dialog" aria-label="File drop zone">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl text-center">
        <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">Drop files here</p>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Release to upload</p>
    </div>
</div>

<!-- Upload Progress -->
<div id="upload-progress" class="hidden fixed bottom-20 right-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 w-64 transition-all duration-300 transform translate-y-0" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
    <div class="text-sm mb-2 text-gray-800 dark:text-gray-100">Uploading files...</div>
    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
    </div>
</div>

<!-- Feedback Message -->
<div id="feedback-message" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 max-w-md w-full text-center"></div>

{% endblock %}

{% block head %}
{{ super() }}
<!-- Pre-initialize chat configuration -->
<script type="text/javascript">
    window.CHAT_CONFIG = {
        chatId: "{{ chat_id or '' }}",
        editModelUrl: "{{ url_for('model.edit_model', model_id=0) }}",
        maxFileSize: parseInt("{{ config.get('MAX_FILE_SIZE', 10 * 1024 * 1024)|string }}"),
        maxFiles: parseInt("{{ config.get('MAX_FILES', 5)|string }}"),
        maxMessageLength: parseInt("{{ config.get('MAX_MESSAGE_LENGTH', 1000)|string }}"),
        allowedFileTypes: JSON.parse('{{ config.get("ALLOWED_FILE_TYPES", ["text/plain", "application/pdf", "text/x-python", "application/javascript", "text/markdown", "image/jpeg", "image/png", "text/csv"])|tojson|safe }}'),
        csrfToken: "{{ csrf_token() }}",
        userId: "{{ current_user.id }}",
        userRole: "{{ current_user.role }}"
    };

    // Validate chat configuration
    if (!window.CHAT_CONFIG.chatId) {
        console.warn('Chat ID not initialized');
    }
    if (!window.CHAT_CONFIG.csrfToken) {
        console.error('CSRF token not found');
    }
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Define CHAT_CONFIG before loading chat.js -->
<script>
    window.CHAT_CONFIG = {
        chatId: "{{ chat_id }}",
        editModelUrl: "{{ url_for('model.edit_model', model_id=0) }}",
        maxFileSize: parseInt("{{ config.get('MAX_FILE_SIZE', 10 * 1024 * 1024)|string }}"),
        maxFiles: parseInt("{{ config.get('MAX_FILES', 5)|string }}"),
        maxMessageLength: parseInt("{{ config.get('MAX_MESSAGE_LENGTH', 1000)|string }}"),
        allowedFileTypes: JSON.parse('{{ config.get("ALLOWED_FILE_TYPES", ["text/plain", "application/pdf", "text/x-python", "application/javascript", "text/markdown", "image/jpeg", "image/png", "text/csv"])|tojson|safe }}'),
        csrfToken: "{{ csrf_token() }}",
        userId: "{{ current_user.id }}",
        userRole: "{{ current_user.role }}"
    };

    // Validate chat configuration
    if (!window.CHAT_CONFIG.chatId) {
        console.warn('Chat ID not initialized');
    }
    if (!window.CHAT_CONFIG.csrfToken) {
        console.error('CSRF token not found');
    }
</script>
<!-- Load chat.js directly -->
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
